<!DOCTYPE html>
<html lang="mk">
  <head>
    <!-- Meta tags and title -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YouthCall</title>

    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />

    <!-- Fonts and Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito+Sans:opsz,wght@6..12,400;6..12,600;6..12,700;6..12,800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"
    />

    <!-- Styles and scripts -->
    <link rel="stylesheet" href="assets/styles/styles.css" />
    <script defer src="assets/scripts/index.js"></script>
  </head>
  <body>
    <nav class="background-light-blur">
      <div class="container">
        <div class="navigation">
          <a href="index.html">
            <img
              src="assets/images/youthcall-logo.svg"
              alt="YouthCall Logo"
              class="logo navigation__logo"
            />
          </a>

          <button class="nav-toggle">
            <span class="material-symbols-outlined"> menu </span>
          </button>

          <ul class="nav-list" aria-expanded="false">
            <li class="nav-list-item">
              <a href="index.html" class="nav-list-link">Почетна</a>
            </li>
            <li class="nav-list-item">
              <a href="posts.html?type=course" class="nav-list-link">Обуки</a>
            </li>
            <li class="nav-list-item">
              <a href="posts.html?type=project" class="nav-list-link"
                >Проекти</a
              >
            </li>
            <li class="nav-list-item">
              <a href="posts.html?type=activity" class="nav-list-link"
                >Активности</a
              >
            </li>
            <li class="nav-list-item">
              <a href="posts.html?type=volunteer" class="nav-list-link"
                >Волонтерство</a
              >
            </li>
            <li class="nav-list-item">
              <a href="documents.html" class="nav-list-link">Документи</a>
            </li>
            <li class="nav-list-item" data-hide="logged">
              <a href="login.html" class="nav-list-link btn btn--secondary"
                >Најави Се</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <main class="margin-block--xl">
      <div class="container">
        <h1 class="text--center header-xl">Мои Постови</h1>

        <section class="my-posts" aria-label="My Posts">
          <div class="loader"></div>
        </section>
      </div>
    </main>

    <footer>
      <div class="container">
        <div class="footer background-dark">
          <div class="footer__content">
            <div class="footer__content-data">
              <img
                src="assets/images/youthcall-logo.svg"
                alt="YouthCall Logo"
                class="logo footer__content-data-logo"
              />

              <p class="footer__content-data-paragraph">
                Aктуелни информации за можности за млади во нашиот регион,
                вклучувајќи ги Еразмус+ проектите, волонтерствa и настани.
              </p>
            </div>
            <div class="footer__content-links">
              <ul class="footer__content-links-list">
                <li class="footer__content-links-list-item">
                  <a href="index.html">Почетна</a>
                </li>
                <li class="footer__content-links-list-item">
                  <a href="about.html">За Проектот</a>
                </li>
              </ul>

              <ul class="footer__content-links-list">
                <li class="footer__content-links-list-item">
                  <a href="posts.html?type=course">Обуки</a>
                </li>
                <li class="footer__content-links-list-item">
                  <a href="posts.html?type=project">Проекти</a>
                </li>
                <li class="footer__content-links-list-item">
                  <a href="posts.html?type=activity">Активности</a>
                </li>
                <li class="footer__content-links-list-item">
                  <a href="posts.html?type=volunteer">Волонтерства</a>
                </li>
                <li class="footer__content-links-list-item">
                  <a href="documents.html">Документи</a>
                </li>
              </ul>

              <ul class="footer__content-links-list">
                <li class="footer__content-links-list-item">
                  <a href="login.html">Најави Се</a>
                </li>
                <li
                  class="footer__content-links-list-item"
                  data-hide="notLogged"
                >
                  <a href="publish.html">Нов Пост</a>
                </li>
                <li
                  class="footer__content-links-list-item"
                  data-hide="notLogged"
                >
                  <a href="my-posts.html">Мои Постови</a>
                </li>
              </ul>
            </div>
          </div>

          <div class="footer__copyright">
            <p class="footer__copyright-copyright">
              Copyright &copy; <span>2023</span> YouthCall. All rights reserved.
            </p>
            <p class="footer__copyright-developedby">
              Developed by
              <a href="https://dimitark.com" target="_blank"
                >Dimitar Kalapocev</a
              >
            </p>
          </div>
        </div>
      </div>
    </footer>

    <script>
      const myPostsContainer = document.querySelector('.my-posts');
      const username = sessionStorage.getItem('username');
      const website = sessionStorage.getItem('website');
      const accountName = sessionStorage.getItem('accountName');

      if (!username && !website && !accountName) {
        location.replace('/login.html');
      }

      const getPostsByUsername = async () => {
        try {
          const username = sessionStorage.getItem('username');
          const data = await fetch(`/api/data?username=${username}`);
          const posts = await data.json();

          posts.data.filteredPosts.forEach((post) => {
            const imageBlob = new Blob([new Uint8Array(post.image.data.data)], {
              type: post.image.contentType,
            });

            const imageUrl = URL.createObjectURL(imageBlob);

            const html = `
              <div class="my-posts__post">
                <img
                  class="my-posts__post-image"
                  src="${imageUrl}"
                  alt="${post.name}"
                />
                <div class="my-posts__post-content">
                  <h2 class="my-posts__post-heading header-m">${post.name}</h2>
                  <button class="my-posts__post-btn" data-post-id="${post._id}">
                    <span class="material-symbols-outlined"> delete </span>
                  </button>
                </div>
              </div>
            `;

            myPostsContainer.insertAdjacentHTML('afterbegin', html);
          });
        } catch (err) {
          console.error(err);
        } finally {
          document.querySelector('.loader').style.display = 'none';
        }
      };

      const deletePost = async (postId) => {
        try {
          const response = await fetch(`/api/data/${postId}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
            },
          });

          if (!response.ok) {
            throw new Error('Network response was not ok');
          }

          const data = await response.json();
          myPostsContainer.insertAdjacentHTML(
            'beforebegin',
            `<p class='text--center'>${data.data}</p>`
          );

          setTimeout(() => {
            location.reload();
          }, 2000);
        } catch (err) {
          console.error(err);
        }
      };

      myPostsContainer.addEventListener('click', (e) => {
        const deleteBtn = e.target.closest('.my-posts__post-btn');
        if (!deleteBtn) return;

        const postId = deleteBtn.dataset.postId;
        deletePost(postId);
      });

      getPostsByUsername();
    </script>
  </body>
</html>
