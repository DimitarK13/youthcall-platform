<!DOCTYPE html>
<html lang="mk">
  <head>
    <!-- Meta tags and title -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YouthCall</title>

    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />

    <!-- Fonts and Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito+Sans:opsz,wght@6..12,400;6..12,600;6..12,700;6..12,800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"
    />

    <!-- Styles and scripts -->
    <link rel="stylesheet" href="assets/styles/styles.css" />
    <script defer src="assets/scripts/index.js"></script>
  </head>
  <body>
    <nav class="background-light-blur">
      <div class="container">
        <div class="navigation">
          <a href="index.html">
            <img
              src="assets/images/youthcall-logo.svg"
              alt="YouthCall Logo"
              class="logo navigation__logo"
            />
          </a>

          <button class="nav-toggle">
            <span class="material-symbols-outlined"> menu </span>
          </button>

          <ul class="nav-list" aria-expanded="false">
            <li class="nav-list-item">
              <a href="index.html" class="nav-list-link">Почетна</a>
            </li>
            <li class="nav-list-item">
              <a href="posts.html?type=course" class="nav-list-link">Обуки</a>
            </li>
            <li class="nav-list-item">
              <a href="posts.html?type=project" class="nav-list-link"
                >Проекти</a
              >
            </li>
            <li class="nav-list-item">
              <a href="posts.html?type=activity" class="nav-list-link"
                >Активности</a
              >
            </li>
            <li class="nav-list-item">
              <a href="posts.html?type=volunteer" class="nav-list-link"
                >Волонтерство</a
              >
            </li>
            <li class="nav-list-item">
              <a href="documents.html" class="nav-list-link">Документи</a>
            </li>
            <li class="nav-list-item">
              <a href="login.html" class="nav-list-link btn btn--primary-light"
                >Најави Се</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <main class="margin-block--xl">
      <div class="container">
        <form
          class="new-post"
          action="/"
          method="post"
          enctype="multipart/form-data"
        >
          <div class="new-post__inputs">
            <div class="input-field">
              <label class="input-field__label" for="type">Вид на пост</label>
              <select class="input-field__input" name="type" id="type">
                <option value="course">Обука</option>
                <option value="project">Проект</option>
                <option value="activity">Активност</option>
                <option value="volunteer">Волонтерство</option>
              </select>
            </div>
            <div class="input-field">
              <label class="input-field__label" for="name">Име на настан</label>
              <input
                class="input-field__input"
                type="text"
                name="name"
                id="name"
                autocomplete="off"
              />
            </div>
            <div class="input-field">
              <label class="input-field__label" for="where">Каде</label>
              <input
                class="input-field__input"
                type="text"
                name="where"
                id="where"
                autocomplete="off"
              />
            </div>
            <div class="input-field">
              <label class="input-field__label" for="when">Кога</label>
              <input
                class="input-field__input"
                type="date"
                name="when"
                id="when"
                autocomplete="off"
              />
            </div>
            <div class="input-field">
              <label class="input-field__label" for="who">Кој</label>
              <input
                class="input-field__input"
                type="text"
                name="who"
                id="who"
                autocomplete="off"
              />
            </div>
            <div class="input-field">
              <label class="input-field__label" for="deadline"
                >Краен рок за пријавување</label
              >
              <input
                class="input-field__input"
                type="date"
                name="deadline"
                id="deadline"
              />
            </div>
            <div class="input-field">
              <label class="input-field__label" for="link"
                >Линк за пријавување</label
              >
              <input
                class="input-field__input"
                type="text"
                name="link"
                id="link"
              />
            </div>
            <div class="input-field">
              <label class="input-field__label" for="image">Слика</label>
              <input
                class="input-field__input"
                type="file"
                name="image"
                id="image"
                accept="image/png, image/jpeg"
              />
            </div>
            <div class="input-field input-textarea">
              <label class="input-field__label" for="description"
                >Дескрипција</label
              >
              <textarea
                class="input-field__input"
                name="description"
                id="description"
                rows="7"
                cols="30"
              ></textarea>
            </div>

            <button class="input-field__btn btn btn--primary" type="submit">
              Објави
            </button>
            <span class="error-message"></span>
            <span class="success-message header-m"></span>
          </div>
        </form>
      </div>
    </main>

    <script>
      const form = document.querySelector('.new-post');
      const type = document.querySelector('#type');
      const name = document.querySelector('#name');
      const where = document.querySelector('#where');
      const when = document.querySelector('#when');
      const who = document.querySelector('#who');
      const deadline = document.querySelector('#deadline');
      const link = document.querySelector('#link');
      const image = document.querySelector('#image');
      const description = document.querySelector('#description');
      const errorMessage = document.querySelector('.error-message');
      const username = sessionStorage.getItem('username');

      form.addEventListener('change', function () {
        validateFields();
      });

      form.addEventListener('submit', function (e) {
        e.preventDefault();

        const errorMessage = document.querySelector('.error-message');
        const successMessage = document.querySelector('.success-message');

        if (validateFields()) {
          errorMessage.textContent = '';

          const formData = new FormData();
          formData.append('type', type.value);
          formData.append('name', name.value);
          formData.append('where', where.value);
          formData.append('when', when.value);
          formData.append('who', who.value);
          formData.append('deadline', deadline.value);
          formData.append('link', link.value);
          formData.append('image', image.files[0]); // Assuming 'image' is an input element of type file
          formData.append('description', description.value);
          formData.append('username', username);

          fetch('/api/data', {
            method: 'POST',
            body: formData,
          })
            .then((response) => response.json())
            .then((data) => {
              errorMessage.style.display = 'none';
              successMessage.textContent = data.data;

              setTimeout(() => {
                location.replace('/my-posts.html');
              }, 2000);
            })
            .catch((error) => {
              console.log('Error' + error);
              errorMessage.textContent = error;
            });
        } else {
          errorMessage.textContent =
            'Please fill in all required fields correctly.';
        }
      });

      function validateFields() {
        const fields = [type, name, where, who, deadline, link, description];

        let isValid = true;

        fields.forEach((field) => {
          if (!field.value.trim()) {
            field.classList.add('input-field__input--invalid');
            isValid = false;
          } else {
            field.classList.remove('input-field__input--invalid');
          }
        });

        const today = new Date().toISOString().split('T')[0];
        const tomorrowISO = new Date(Date.now() + 86400000)
          .toISOString()
          .split('T')[0];

        if (when.value < tomorrowISO || when.value === today) {
          when.classList.add('input-field__input--invalid');
          errorMessage.textContent = 'When date cannot be before today';
          isValid = false;
        } else {
          when.classList.remove('input-field__input--invalid');
        }

        if (deadline.value < tomorrowISO || deadline.value === today) {
          deadline.classList.add('input-field__input--invalid');
          errorMessage.textContent = 'Deadline cannot be before today';
          isValid = false;
        } else {
          deadline.classList.remove('input-field__input--invalid');
        }

        if (link && !isURL(link.value.trim())) {
          link.classList.add('input-field__input--invalid');
          isValid = false;
        } else {
          link.classList.remove('input-field__input--invalid');
        }

        if (!image.files || !image.files[0]) {
          image.classList.add('input-field__input--invalid');
          isValid = false;
        } else {
          const maxSize = 5 * 1024 * 1024;
          if (image.files[0].size > maxSize) {
            image.classList.add('input-field__input--invalid');
            errorMessage.textContent = 'Image cannot be bigger than 5mb';
            isValid = false;
          } else {
            image.classList.remove('input-field__input--invalid');
          }
        }

        if (
          description.value.trim().length === 0 ||
          description.value.length > 500
        ) {
          description.classList.add('input-field__input--invalid');
          errorMessage.textContent = `Description shouldn't be empty or over 500 characters`;
          isValid = false;
        } else {
          description.classList.remove('input-field__input--invalid');
        }

        return isValid;
      }

      function isURL(str) {
        const pattern =
          /^(https?:\/\/)?(www\.)?([\w-]+\.)+([a-z]{2,})+(\/[\w-]+)*(\?.*)?$/;
        return pattern.test(str);
      }
    </script>
  </body>
</html>
